#!/usr/bin/python
# bean-add - A beancount transaction entry assistant
# Author: Simon Volpert <simon@simonvolpert.com>
# License: "Do what you feel is right, but don't be a jerk" public license.
# See the README.md file for additional information

import readline
import sys
import datetime


readline.parse_and_bind("tab: complete")

accounts = []
descriptions = []
commands = ['balance']
currencies = []

def confirm(prompt=''):
	global vocab
	vocab = []
	while True:
		ch = input(prompt).lower()
		if ch == 'y':
			return True
		elif ch == 'n':
			return False


with open(sys.argv[1], 'r') as source_file:
	for line in source_file:
		line = line.strip()
		if line == '':
			continue
		data = line.split(' ')
		try:
			if data[1] == 'open':
				accounts.append(data[2])
			elif data[1] == '*':
				descriptions.append(line[13:].strip('" '))
			elif data[0] in accounts and len(data) > 1:
				_cur = data.pop()
				if _cur not in currencies:
					currencies.append(_cur)
		except IndexError:
			continue

if len(accounts) > 0:
	print('%s account(s), %s unique description(s), %s currencies loaded\n' % (len(accounts), len(descriptions), len(currencies)))
else:
	print('File contains no account definitions.')
	if not confirm('Proceed with editing? (y/n) '):
		sys.exit()

descriptions += commands

def complete(text, state):
	results = [x for x in vocab if x.startswith(text)] + [None]
	return results[state]

readline.set_completer(complete)

date = datetime.date.today()
date = '%04d-%02d-%02d' % (date.year, date.month, date.day)
while True:
	output = ''
	definitions = ''
	_reading = input('Enter transaction date [%s]: ' % date)
	date = _reading if _reading != '' else date
	vocab = descriptions
	readline.set_completer_delims('')
	description = input('Enter transaction description (or `balance`): ')
	if description == "balance":
		print('\nBalance assertion mode.')
	else:
		output += '%s * "%s"\n' % (date, description)
	while True:
		vocab = accounts
		account = input('Enter account name (tab to complete, enter to fininsh): ')
		if account == '':
			break
		if account not in accounts:
			if not confirm('The account `%s` is not in the journal file. Add it? (y/n) ' % account):
				continue
			definitions += '%s open %s\n' % (date, account)
		vocab = currencies
		readline.set_completer_delims(' ')
		amount = input('Enter amount (including currency symbol): ')
		if description == 'balance':
			output += '%s %s %s %s\n' % (date, description, account, amount)
			break
		else:
			output += '	%s %s\n' % (account, amount)
	with open(sys.argv[1], 'a') as source_file:
		source_file.write(definitions + '\n')
		source_file.write(output)
	print('\nTransaction recorded.')
	print('\nResults:\n%s\n%s' % (definitions, output))
	if not confirm('Input anoter transaction? (y/n) '):
		print('\nRemember that there is no input validation whatsoever! Please run `bean-check` and correct any errors manually.')
		sys.exit()

